name: Test

on:
  push:
    branches:
      - main

env:
  FORCE_COLOR: 1

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24

      - name: Authenticate with GCloud
        id: "auth"
        uses: "google-github-actions/auth@v1"
        with:
          workload_identity_provider: projects/546356038464/locations/global/workloadIdentityPools/github-pool/providers/github-ci
          service_account: grog-sa@grog-457510.iam.gserviceaccount.com

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"

      - name: Configure Docker
        id: "configure-docker"
        run: gcloud auth configure-docker us-east1-docker.pkg.dev

      - name: Install dependencies
        run: |
          go mod tidy
          go install gotest.tools/gotestsum@latest

      - name: Install pkl
        run: |
          curl -L -o pkl-bin 'https://github.com/apple/pkl/releases/download/0.28.2/pkl-linux-amd64'
          chmod +x pkl-bin
          sudo mv pkl-bin /usr/local/bin/pkl

          pkl --version

      - name: Build and test
        run: make full-test

      - name: Upload coverage badge
        if: github.ref == 'refs/heads/main'
        run: |
          .github/upload_badge.sh
